<link rel="stylesheet" href="css/styles.css"/>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ghosty Games - Unblocked Games</title>
</head>
<body>
    <header>
        <img src="Images/NEWGhostyGames.png" class="logo" alt="Logo" style="width:180px;height:150px;">
        <h1>Ghosty Games</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
            <a href="donate.html">Donate</a>
        </nav>

        <div class="login-container" id="login-container">
            <button id="login-button">
                <a href="login.html" id="login">Log In</a>
            </button>
        </div>

                <div id="profile-container" style="display:none;" class="profile-dropdown">
                    <button class="profile-btn" id="profile-btn">Profile ▼</button>
                    <div class="profile-menu" id="profile-menu">
                        <p><strong>Email:</strong> <span id="profile-email"></span></p>
                        <input type="text" id="username-prefix" placeholder="Enter custom username">
                        <button class="save-btn" id="save-username">Save Username</button>
                        <button class="logout-btn" id="logout-button">Log Out</button>
                    </div>
                </div>

        <div class="search-container">
            <input type="text" placeholder="Search games..." id="search-input">
            <button id="search-button">Search</button>
        </div>
    </header>

    <main style="text-align:center; margin-top:20px;">
        <h2>Your Favorite Games</h2>
        <div id="favorites-list" style="display:flex; flex-wrap:wrap; justify-content:center; gap:20px;">
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDSpebs9nP97-IkXXGALGR2vCqcTTOzlyo",
            authDomain: "ghoatygames.firebaseapp.com",
            projectId: "ghoatygames",
            storageBucket: "ghoatygames.firebasestorage.app",
            messagingSenderId: "606779515816",
            appId: "1:606779515816:web:774ccc3cd8d7f895f7339d",
            measurementId: "G-CCE1LRLR46"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const favoritesList = document.getElementById("favorites-list");

        async function loadFavorites(user) {
            try {
                const favsCol = collection(db, "users", user.uid, "favorites");
                const favsSnap = await getDocs(favsCol);

                if (favsSnap.empty) {
                    favoritesList.innerHTML = "<p>You have no favorite games yet.</p>";
                } else {
                    favoritesList.innerHTML = "";
                    favsSnap.forEach((favDoc) => {
                        const game = favDoc.data();

                        const card = document.createElement("div");
                        card.style.width = "165px";
                        card.style.border = "1px solid #ccc";
                        card.style.padding = "10px";
                        card.style.borderRadius = "10px";
                        card.style.background = "#282b33";
                        card.style.boxShadow = "0 2px 5px rgba(0,0,0,0.1)";

                        const img = game.image ? game.image : "Images/default-thumbnail.png";

                        card.innerHTML = `
                            <img src="${img}" alt="${game.title}" style="width:100%; height:120px; object-fit:cover; border-radius:8px;">
                            <h3><b>${game.title}</b></h3>
                            <a href="${game.url}" style="display:inline-block; margin-top:10px; color:#fff; "><b>Play Now</b></a>
                            <button style="margin-top:10px; background:#282b33; color:#fff; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                                Remove
                            </button>
                        `;

                   
                        card.querySelector("button").addEventListener("click", async () => {
                            try {
                                await deleteDoc(doc(db, "users", user.uid, "favorites", favDoc.id));
                                alert(`${game.title} removed from Favorites.`);
                                loadFavorites(user); 
                            } catch (err) {
                                console.error("Error removing favorite:", err);
                                alert("Failed to remove favorite.");
                            }
                        });

                        favoritesList.appendChild(card);
                    });
                }
            } catch (err) {
                console.error("Error loading favorites:", err);
                favoritesList.innerHTML = "<p>Failed to load favorites. Check console for details.</p>";
            }
        }

        let username = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById("login-container").style.display = "none";
                document.getElementById("profile-container").style.display = "inline-block";
                document.getElementById("profile-email").textContent = user.email;
                const userRef = doc(db, "leaderboard", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    username = userSnap.data().username || null;
                    document.getElementById("profile-btn").textContent = (username || user.email) + " ▼";
                }
                loadFavorites(user);
            } else {
                favoritesList.innerHTML = "<p>Please log in to see your favorites.</p>";
                document.getElementById("login-container").style.display = "inline-block";
                document.getElementById("profile-container").style.display = "none";
            }
        });

        document.getElementById("profile-btn").addEventListener("click", () => {
            document.getElementById("profile-container").classList.toggle("active");
        });

        document.getElementById("save-username").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (user) {
                username = document.getElementById("username-prefix").value.trim();
                if (username) {
                    try {
                        await setDoc(doc(db, "leaderboard", user.uid), { username: username }, { merge: true });
                        document.getElementById("profile-btn").textContent = username + " ▼";
                        alert("Username saved");
                    } catch (err) {
                        alert("Failed to save username");
                    }
                }
            }
        });

        document.getElementById("logout-button").addEventListener("click", async () => {
            await signOut(auth);
            location.reload();
        });
    </script>
</body>
</html>
